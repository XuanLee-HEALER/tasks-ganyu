# tasks-ganyu

一个实现任务管理器相关功能的库

## 介绍

任务管理器是对任务的添加、删除、执行等过程进行管理的系统。类似于Windows的任务管理器，所有的任务应该有一个Owner，任务可以是单个任务，也可以是批量任务。最小单位的任务（一个函数）会在一个`goroutine`中执行，每个任务（包含子任务）占用的系统资源（包含CPU、内存、文件描述符等情况）需要被监控

## 设计

目前设计包含几个抽象

- `TaskManager` 提供任务管理器所有主要的API，是使用者主要的交互的对象
- `Task` 任务接口，使用者通过自定义类型来实现此接口制作任务实例
- `BatchTask` 批量任务接口，用法同上

### 任务

单个任务的类型包括

1. 立即执行的任务
2. 等待固定时间执行的任务
3. 携带触发条件的任务
4. 循环执行的任务

任务的其它重要属性包括：优先级（是否为优先级任务），超时时间

任务可以将执行进度、执行trace信息单独保存，在任务结束后返回给提交任务的用户

批量任务的主体是单个任务的集合，但是附带执行策略，这些策略包含

1. 串行执行
2. 并行执行
   1. 任意任务失败则整个任务失败
   2. 仅等待所有任务执行完成

### 任务管理器

基本的业务流程

1. 用户向任务管理器注册（`Register`），得到自己的ID
2. 用户使用ID和任务实例（实现`Task`或者`BatchTask`接口）向任务管理器添加任务（`Commit`）
3. 提交过程中
   1. 校验ID是否存在
   2. 为任务初始化输出、错误、trace信息、进度等`channel`，包装任务实例，生成任务ID，关联任务与用户
4. 将任务传输到对应的队列，并且通知执行程序（独立`goroutine`）准备执行任务
5. 执行程序从队列中获取任务，根据任务类型和相关的执行要求开启新的`goroutine`执行任务
6. 记录任务的执行情况

